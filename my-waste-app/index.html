<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartRecycle AI | Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #0a0a0c; color: #e2e8f0; }
        .glass { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.08); }
        .glow-blue { box-shadow: 0 0 20px rgba(59, 130, 246, 0.2); }
        .step-active { border-color: #3b82f6; background: rgba(59, 130, 246, 0.05); }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .animate-spin-slow { animation: spin 3s linear infinite; }
    </style>
</head>
<body class="min-h-screen overflow-x-hidden">
    <!-- Background Accents -->
    <div class="fixed top-[-10%] left-[-10%] w-[50%] h-[50%] bg-blue-600/10 blur-[120px] rounded-full -z-10"></div>
    <div class="fixed bottom-[-10%] right-[-10%] w-[50%] h-[50%] bg-emerald-600/10 blur-[120px] rounded-full -z-10"></div>

    <nav class="glass sticky top-0 z-50 px-8 py-4 flex justify-between items-center border-b border-white/5">
        <div class="flex items-center gap-3">
            <div class="bg-gradient-to-br from-blue-500 to-emerald-500 p-2 rounded-lg shadow-lg">
                <i data-lucide="recycle" class="text-white w-6 h-6"></i>
            </div>
            <span class="text-2xl font-bold tracking-tight text-white">SmartRecycle <span class="text-blue-500">AI</span></span>
        </div>
        <div class="flex gap-4">
            <div id="hw-status" class="flex items-center gap-2 bg-white/5 px-4 py-1.5 rounded-full border border-white/10">
                <i data-lucide="cpu" class="w-4 h-4 text-red-500"></i>
                <span class="text-xs font-bold uppercase tracking-wider text-slate-400">Hardware</span>
                <div class="w-2 h-2 rounded-full bg-red-500 shadow-[0_0_8px_rgba(239,68,68,0.5)]"></div>
            </div>
        </div>
    </nav>

    <main class="max-w-6xl mx-auto px-6 py-10 grid grid-cols-1 lg:grid-cols-12 gap-8">
        <!-- Left: Workflow -->
        <div class="lg:col-span-7 space-y-6">
            <div id="step-0" class="glass p-6 rounded-2xl transition-all duration-500 step-active">
                <div class="flex items-center gap-4 mb-4">
                    <div class="p-3 bg-blue-500 rounded-xl text-white shadow-lg"><i data-lucide="scale"></i></div>
                    <h3 class="text-xl font-bold text-white">Calibration</h3>
                </div>
                <p class="text-slate-400 mb-6">Resetting the scale to zero for precision. Remove all items from the bin.</p>
                <button onclick="runStep('measure-base')" id="btn-0" class="w-full py-4 bg-blue-600 hover:bg-blue-500 text-white rounded-xl font-bold flex items-center justify-center gap-2 transition-all">
                    Calibrate Scale <i data-lucide="chevron-right"></i>
                </button>
            </div>

            <div id="step-1" class="glass p-6 rounded-2xl opacity-40 transition-all duration-500">
                <div class="flex items-center gap-4 mb-4">
                    <div class="p-3 bg-white/10 rounded-xl text-slate-400"><i data-lucide="camera"></i></div>
                    <h3 class="text-xl font-bold text-white">Visual Analysis</h3>
                </div>
                <p class="text-slate-400 mb-6">Place the item in the tray and scan. AI will identify the material.</p>
                <button onclick="runStep('capture')" id="btn-1" disabled class="w-full py-4 bg-white text-black hover:bg-gray-200 rounded-xl font-bold flex items-center justify-center gap-2 transition-all opacity-50 cursor-not-allowed">
                    Capture & Scan
                </button>
            </div>

            <div id="step-2" class="glass p-6 rounded-2xl opacity-40 transition-all duration-500">
                <div class="flex items-center gap-4 mb-4">
                    <div class="p-3 bg-white/10 rounded-xl text-slate-400"><i data-lucide="scan-search"></i></div>
                    <h3 class="text-xl font-bold text-white">Material Confirm</h3>
                </div>
                <div id="classification-result" class="hidden mb-6 p-4 bg-blue-500/10 rounded-xl border border-blue-500/20">
                    <p class="text-xs uppercase font-bold text-blue-400 mb-1">AI Detection</p>
                    <p id="label-text" class="text-xl font-bold text-white capitalize">---</p>
                </div>
                <button onclick="runStep('classify')" id="btn-2" disabled class="w-full py-4 bg-emerald-600 hover:bg-emerald-500 text-white rounded-xl font-bold flex items-center justify-center gap-2 transition-all opacity-50 cursor-not-allowed">
                    Confirm & Sort
                </button>
            </div>
        </div>

        <!-- Right: Realtime Monitoring -->
        <div class="lg:col-span-5">
            <div class="sticky top-28 space-y-6">
                <!-- Preview Window -->
                <div class="glass aspect-square rounded-3xl overflow-hidden relative group border-white/10">
                    <img id="live-preview" class="w-full h-full object-cover hidden" src="" alt="Preview">
                    <div id="placeholder" class="absolute inset-0 flex flex-col items-center justify-center text-slate-600">
                        <i data-lucide="camera" class="w-16 h-16 mb-4 opacity-20"></i>
                        <p class="font-semibold uppercase tracking-widest text-sm opacity-40">Awaiting Camera</p>
                    </div>
                    <div id="loading-overlay" class="absolute inset-0 bg-black/60 backdrop-blur-sm hidden flex-col items-center justify-center z-20">
                        <i data-lucide="loader-2" class="w-10 h-10 text-blue-500 animate-spin mb-3"></i>
                        <p class="text-blue-500 font-bold uppercase tracking-widest text-xs">AI Processing</p>
                    </div>
                </div>

                <!-- Final Receipt (Success State) -->
                <div id="final-card" class="hidden glass p-8 rounded-3xl border-emerald-500/30 bg-emerald-500/5 text-center animate-in fade-in zoom-in duration-500">
                    <div class="w-16 h-16 bg-emerald-500 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i data-lucide="check" class="text-white w-8 h-8"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-white">Process Complete</h2>
                    <div class="grid grid-cols-2 gap-4 mt-6">
                        <div class="bg-black/20 p-4 rounded-2xl border border-white/5">
                            <p class="text-[10px] uppercase font-bold text-slate-500">Weight</p>
                            <p id="res-weight" class="text-xl font-bold text-white">0g</p>
                        </div>
                        <div class="bg-black/20 p-4 rounded-2xl border border-white/5">
                            <p class="text-[10px] uppercase font-bold text-slate-500">Reward</p>
                            <p id="res-reward" class="text-xl font-bold text-emerald-400">₹0</p>
                        </div>
                    </div>
                    <div class="mt-6 bg-white p-4 rounded-xl inline-block">
                        <img id="res-qr" class="w-32 h-32" src="" alt="QR">
                    </div>
                    <button onclick="location.reload()" class="mt-8 w-full py-3 bg-white/10 hover:bg-white/20 rounded-xl text-white font-bold transition-all">
                        New Scan
                    </button>
                </div>
            </div>
        </div>
    </main>

    <script>
        const API_BASE = "http://localhost:8000";
        let currentWasteType = null;

        async function updateStatus() {
            try {
                const res = await fetch(`${API_BASE}/status`);
                const data = await res.json();
                const statusDiv = document.getElementById('hw-status');
                if(data.arduino_connected) {
                    statusDiv.querySelector('i').classList.replace('text-red-500', 'text-emerald-500');
                    statusDiv.querySelector('div').classList.replace('bg-red-500', 'bg-emerald-500');
                    statusDiv.querySelector('div').classList.replace('shadow-[0_0_8px_rgba(239,68,68,0.5)]', 'shadow-[0_0_8px_rgba(16,185,129,0.5)]');
                }
            } catch(e) {}
        }

        async function runStep(type) {
            setLoading(true);
            try {
                if (type === 'measure-base') {
                    await fetch(`${API_BASE}/measure-base`, { method: 'POST' });
                    activateStep(1);
                } 
                else if (type === 'capture') {
                    const res = await fetch(`${API_BASE}/capture`, { method: 'POST' });
                    const data = await res.json();
                    document.getElementById('live-preview').src = `data:image/jpeg;base64,${data.image}`;
                    document.getElementById('live-preview').classList.remove('hidden');
                    document.getElementById('placeholder').classList.add('hidden');
                    activateStep(2);
                }
                else if (type === 'classify') {
                    const res = await fetch(`${API_BASE}/classify`, { method: 'POST' });
                    const data = await res.json();
                    currentWasteType = data.type;
                    document.getElementById('classification-result').classList.remove('hidden');
                    document.getElementById('label-text').innerText = data.category;
                    
                    // Final Process call
                    const procRes = await fetch(`${API_BASE}/process-waste`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ type: currentWasteType })
                    });
                    const procData = await procRes.json();
                    showFinal(procData);
                }
            } catch (err) {
                console.error(err);
                alert("Communication Error. Is the backend terminal running?");
            } finally {
                setLoading(false);
            }
        }

        function activateStep(index) {
            for(let i=0; i<=2; i++) {
                const el = document.getElementById(`step-${i}`);
                const btn = document.getElementById(`btn-${i}`);
                if(i === index) {
                    el.classList.add('step-active');
                    el.classList.remove('opacity-40');
                    btn.disabled = false;
                    btn.classList.remove('opacity-50', 'cursor-not-allowed');
                } else {
                    el.classList.remove('step-active');
                    el.classList.add('opacity-40');
                }
            }
        }

        function showFinal(data) {
            document.getElementById('step-0').parentElement.classList.add('hidden');
            document.getElementById('final-card').classList.remove('hidden');
            document.getElementById('res-weight').innerText = `${data.weight}g`;
            document.getElementById('res-reward').innerText = `₹${data.amount}`;
            document.getElementById('res-qr').src = `data:image/png;base64,${data.qr_code}`;
        }

        function setLoading(val) {
            const overlay = document.getElementById('loading-overlay');
            val ? overlay.classList.replace('hidden', 'flex') : overlay.classList.replace('flex', 'hidden');
        }

        lucide.createIcons();
        updateStatus();
        setInterval(updateStatus, 3000);
    </script>
</body>
</html>